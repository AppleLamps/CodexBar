name: CI

on:
  push:
    branches: ["*"]
  pull_request:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0.1"

      - name: Install SwiftFormat
        run: |
          git clone --depth 1 --branch 0.54.6 https://github.com/nicklockwood/SwiftFormat.git /tmp/swiftformat
          cd /tmp/swiftformat
          swift build -c release
          sudo cp .build/release/swiftformat /usr/local/bin/

      - name: SwiftFormat (lint)
        run: swiftformat Sources Tests --lint

  build-linux:
    name: Build Linux (${{ matrix.name }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: x64
            runs-on: ubuntu-24.04
          - name: arm64
            runs-on: ubuntu-24.04-arm
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@v4

      - name: Runner info
        run: |
          set -euo pipefail
          uname -a
          uname -m

      - name: Setup Swift 6.0.1
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0.1"

      - name: Build CodexBarCLI (release, static Swift stdlib)
        run: swift build -c release --product CodexBarCLI --static-swift-stdlib

      - name: Swift Test
        run: swift test --parallel

      - name: Smoke test CodexBarCLI
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR="$(swift build -c release --product CodexBarCLI --static-swift-stdlib --show-bin-path)"
          BIN="$BIN_DIR/CodexBarCLI"
          "$BIN" --help >/dev/null
          "$BIN" --version >/dev/null

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0.1"

      - name: Swift version
        run: swift --version

      - name: Build CodexBarCLI (release)
        run: swift build -c release --product CodexBarCLI

      - name: Swift Test
        run: swift test --parallel

      - name: Smoke test CodexBarCLI
        shell: pwsh
        run: |
          $binPath = swift build -c release --product CodexBarCLI --show-bin-path
          $exe = Join-Path $binPath "CodexBarCLI.exe"
          & $exe --help
          & $exe --version

  build-windows-gui:
    name: Build Windows GUI
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore Sources/CodexBarWindows/CodexBarWindows.csproj

      - name: Build GUI
        run: dotnet build Sources/CodexBarWindows/CodexBarWindows.csproj -c Release --no-restore
